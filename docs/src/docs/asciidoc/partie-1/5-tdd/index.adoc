
include::../../header.adoc[]

image::banner.png[width=100%]

Le développement par les tests est une technique de développement Agile

== Le cycle de développement

=== La boucle d'ajout de fonctionnalité

[ditaa, 'TDD cycle', align="center"]
----
+--------------+
|cE54          |
|              |
|              |<----------+
|  add a test  |           |
|              |           |
|              |           |
|              |           |
+------+-------+           |
       |                   |
       |                   |
       v                   |
+--------------+           |
|c9FA          |           |
|              |           |
|              |           |  loop
| make it pass |           |
|              |           |
|              |           |
|              |           |
+------+-------+           |
       |                   |
       |                   |
       v                   |
+--------------+           |
|c9BF          |           |
|              |           |
|              |           |
|   refactor   +-----------+
|              |
|              |
|              |
+--------------+
----

=== Avantages

* On se place en tant qu'utilisateur de ce qu'on construit
* Le code est testé et on réduit le risque de régression
* On aboutit à un design plus ouvert / plus flexible

== jUnit

https://en.wikipedia.org/wiki/Kent_Beck[Kent Beck] est à l'origine du TDD et des frameworks xUnit.

En java, jUnit est un framework permettant d'écrire des tests unitaires.

En version 4, un test s'écrit :

[source,java]
----
import org.junit.*;
import static org.junit.Assert.*;
import java.util.*;

public class ArrayListTest {

    private ArrayList list;

    @Before
    public void setUp() { <1>
        list = new ArrayList();
    }

    @After
    public void tearDown() { <2>
    }

    @Test
    public void empty() {
        assertTrue(list.isEmpty());
    }

    @Test
    public void add() {
        collection.add("itemA");
        assertEquals(1, list.size());
    }
}
----
<1> exécuté avant chaque test
<2> exécuté après chaque test

== Un cas pratique

=== Répertoires de source

Dans notre 'test-project' nous ajoutons les répertoires suivants :

[source,terminal]
----
test-project$ mkdir -p src/main/java src/test/java
----

* `src/main/java` va contenir nos sources java
* `src/test/java` va contenir nos tests java

=== package fr.ecm.test

On ajoute le package `fr.ecm.tp` dans `src/main/java`

image:add-package.png[]

=== Calculator.java

On ajoute la classe `Calculator` dans le package `fr.ecm.tp`

image:add-class.png[]

[source,java]
.Calculator.java
----
package fr.ecm.tp;

public class Calculator {
    public int add(int a, int b) {
        return 0;
    }
}
----

=== CalculatorTest.java

En faisant un kbd:[alt,return] on peut facilement ajouter un test

image:create-test.png[]

On choisit Junit4

image:create-test-junit4.png[]

Le fichier CalculatorTest.java va automatiquement dans le package `fr.ecm.tp` de `src/main/java`

=== Premier test

Nous rajoutons notre premier test

[source,java]
.CalculatorTest.java
----
package fr.ecm.tp;

import org.junit.Test;

import static org.junit.Assert.*;

public class CalculatorTest {
    private Calculator calculator = new Calculator();

    @Test
    public void add() {
        assertEquals(3, calculator.add(1, 2));
    }
}
----

On lance le test en faisant un click droit sur la classe

image:launch-test.png[]

Ce qui donne le résultat

image:test-result.png[]

=== Faire passer le test

Faites ce qu'il faut pour que le test passe.

Après cela, pour le moment, il n'y a pas grand chose à refactorer.

=== Test suivant

La soustraction n'est pas très intéressante (ce n'est qu'une addition déguisée).

Faire le test et puis le code pour la multiplication `calculator.multiply(6, 4)`

=== Division

La division présente un petit plus, que se passe t il si on fait un `calcultator.divide(3, 0)` ?

Le test est l'occation de prendre une décision sur le comportement de cette méthode `divide`.

Il y a plusieurs possibilités :

* lancer une exception adaptée
* faire un `assert`
* retourner une valeur remarquable (-1 ?)

Dans notre cas, l'exception la plus adaptée est `IllegalArgumentException`

Le test de la condition aux limites peut s'écrire

[source,java]
.CalculatorTest.java
----
@Test(expected = IllegalArgumentException.class)
public void divideByZero() {
    calculator.divide(3, 0);
}
----

Ecrire les tests `divide` et `divideByZero` et le code associé.

=== Lambdas

Sans toucher les tests, nous allons transformer notre code.

[NOTE]
.Les lambdas
====
C'est une nouveauté java 8 : c'est l'arrivée d'un peu de programmation fonctionelle.
====

TODO
