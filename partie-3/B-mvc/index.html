<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Annexe B : L&#8217;architecture MVC</title>
<link rel="stylesheet" href="./../../style.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article">
<div id="header">
<h1>Annexe B : L&#8217;architecture MVC</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;architecture MVC repose sur la séparation des responsabilités.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="mvc2.png" alt="mvc2">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>le front controller dispatch les requêtes vers les bons composants</p>
</li>
<li>
<p>les controllers traitent les requêtes à l&#8217;aide de sous composants</p>
</li>
<li>
<p>les view sont chargées de faire le rendu html</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_xml">web.xml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le descripteur de déploiement (web.xml) comporte ce qu&#8217;il faut afin de charger le contexte spring</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Handles Spring requests --&gt;</span>
<span class="tag">&lt;servlet&gt;</span>
 <span class="tag">&lt;servlet-name&gt;</span>spring<span class="tag">&lt;/servlet-name&gt;</span>
 <span class="tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/servlet-class&gt;</span>
 <span class="tag">&lt;load-on-startup&gt;</span>1<span class="tag">&lt;/load-on-startup&gt;</span>
<span class="tag">&lt;/servlet&gt;</span>
<span class="tag">&lt;servlet-mapping&gt;</span>
 <span class="tag">&lt;servlet-name&gt;</span>spring<span class="tag">&lt;/servlet-name&gt;</span>
 <span class="tag">&lt;url-pattern&gt;</span>/<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le contrôleur frontal (DispatcherServlet) distribue toutes les requêtes (mapping sur /).</p>
</div>
<div class="paragraph">
<p>Le nom de la servlet (ici spring) détermine le nom par défaut du fichier spring associé.</p>
</div>
<div class="paragraph">
<p>Le fichier spring chargé est donc WEB-INF/spring-servlet.xml</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_servlet_xml">spring-servlet.xml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est un contexte spring dédié à la configuration du mvc</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Activation des annotations --&gt;</span>
<span class="tag">&lt;context:annotation-config</span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Enregistrement de convertisseurs et formatteurs spécifiques au mvc --&gt;</span>
<span class="tag">&lt;mvc:annotation-driven</span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Gestion des fichiers statiques --&gt;</span>
<span class="tag">&lt;mvc:default-servlet-handler</span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Chargement des controllers --&gt;</span>
<span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr.cmm.controller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Définition de la Locale pour les opérations de formattage --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localeResolver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...FixedLocaleResolver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultLocale</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr_FR</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Configure la technologie de templating --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jspViewResolver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...InternalResourceViewResolver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewClass</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...JstlView</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/jsp/</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">suffix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">.jsp</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_helloworldcontroller">HelloWorldController</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un contrôleur est un composant spring spécial dédié aux traitements des requêtes HTTP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
   <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">public</span> <span class="type">void</span> hello(HttpServletResponse response) <span class="directive">throws</span> <span class="exception">IOException</span> {
     response.getWriter().write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello !</span><span class="delimiter">&quot;</span></span>);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Grâce au scan de composants, on peut donc déclarer facilement de nouveaux contrôleurs.</p>
</div>
<div class="paragraph">
<p>L&#8217;annotation <code>@RequestMapping</code> permet de mapper une méthode sur une uri.</p>
</div>
<div class="paragraph">
<p>Tout se fait par annotations et conventions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_forward_vers_la_vue">Le forward vers la vue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans un conteneur de servlet, un forward consiste a passer la main à un autre composant.</p>
</div>
<div class="paragraph">
<p>Pour demander à spring de passer la main à une jsp, on peut retourner le nom du fichier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
   <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">public</span> <span class="predefined-type">String</span> hello(<span class="predefined-type">String</span> name) {
     <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Retourner une chaîne de caractères est interprété comme un forward vers une vue.</p>
</div>
<div class="paragraph">
<p>Vu la configuration de notre ViewResolver, spring va appeler le fichier /WEB-INF/jsp/hello.jsp</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_modèle_et_la_vue">Le modèle et la vue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le rôle du controller est d&#8217;interagir avec les services et de préparer le modèle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
   <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">public</span> <span class="predefined-type">String</span> hello(Model model) {
      model.addAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);

      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le rôle de la vue est de recevoir le modèle de données et de le mettre en forme.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="error">&lt;</span>%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%<span class="error">&gt;</span>
<span class="doctype">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span>
<span class="tag">&lt;html&gt;</span>
 <span class="tag">&lt;head&gt;</span>...<span class="tag">&lt;/head&gt;</span>
 <span class="tag">&lt;body&gt;</span>Hello ${name} !<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__requestparam">@RequestParam</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les paramètres de la requête peuvent être déclarés comme des paramètres de la méthode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://localhost:8080/hello?name=Steven</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et la méthode associée</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> hello(HttpServletResponse response, <span class="predefined-type">String</span> name) <span class="directive">throws</span> <span class="exception">IOException</span> {
        response.getWriter().write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name + <span class="string"><span class="delimiter">&quot;</span><span class="content"> !</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;annotation <code>@RequestParam</code> permet de d&#8217;ajuster le mapping du paramètre.</p>
</div>
<div class="paragraph">
<p>Le framework est capable de convertir les paramètres vers le bon type de données</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://localhost:8080/hello?value=10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et la méthode associée</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> hello(HttpServletResponse response, <span class="predefined-type">Integer</span> value) <span class="directive">throws</span> <span class="exception">IOException</span> {
        response.getWriter().write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + value + <span class="string"><span class="delimiter">&quot;</span><span class="content"> !</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>En cas d&#8217;erreur de conversion (/hello?value=xyz) une erreur 400 (Bad Request) est lancée.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__pathvariable">@PathVariable</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est aussi possible de découper le chemin de la requête et de s&#8217;en servir comme paramètres.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://localhost:8080/hello/Steven</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et la méthode associée</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldController</span> {
    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello/{name}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> hello(HttpServletResponse response, <span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> name) <span class="directive">throws</span> <span class="exception">IOException</span> {
        response.getWriter().write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name + <span class="string"><span class="delimiter">&quot;</span><span class="content"> !</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela permet de construire des urls élégantes plutôt que de reposer sur des paramètres.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_les_formulaires">Les formulaires</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring mvc propose un gestion assez classique des formulaires.</p>
</div>
<div class="paragraph">
<p>Nous allons prendre le formulaire suivant comme exemple.</p>
</div>
<form method="post" action="/editPerson"><span class="pln">nom </span><input type="text" name="name"><span class="pun">,</span><span class="pln"> age </span><input type="text" name="age"><span class="pln"> </span><input type="submit"></form>
<div class="paragraph">
<p>Le code jsp qui correspondant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;form:form</span> <span class="attribute-name">commandName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/editPerson</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   nom <span class="tag">&lt;form:input</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ,age <span class="tag">&lt;form:input</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;form:submit&gt;</span>
   <span class="tag">&lt;form:hidden</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;/form:form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour ce formulaire, nous créons la classe suivante.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PersonForm</span> {
   <span class="directive">private</span> <span class="predefined-type">Long</span> id;

   <span class="directive">private</span> <span class="predefined-type">String</span> name;

   <span class="directive">private</span> <span class="predefined-type">Integer</span> age;

   <span class="comment">// getters and setters</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Par convention, il est pratique d&#8217;utiliser le suffixe Form.</p>
</div>
<div class="paragraph">
<p>Cependant, n&#8217;importe quelle classe avec les accesseurs disponibles pour les champs du formulaire ferait l&#8217;affaire.</p>
</div>
<div class="paragraph">
<p>Il est même possible d&#8217;utiliser des objets du domaine métier qui serviront à la persistance.</p>
</div>
<div class="paragraph">
<p>Le contrôleur supporte l&#8217;affichage et la modification de la donnée</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/editPerson</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PersonController</span> {

   <span class="annotation">@RequestMapping</span>(method = RequestMethod.GET)
   <span class="directive">public</span> <span class="predefined-type">String</span> form(<span class="predefined-type">Long</span> id, Model model) {
      <span class="comment">// aller cherche la personne en base</span>

      <span class="comment">// forwarder vers la vue</span>
   }

   <span class="annotation">@RequestMapping</span>(method = RequestMethod.POST)
   <span class="directive">public</span> <span class="predefined-type">String</span> submit(<span class="annotation">@ModelAttribute</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span>) PersonForm person, BindingResult result) {
        <span class="comment">// gérer les erreurs</span>

        <span class="comment">// sauver et faire un redirect</span>
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_binding_et_validation">Binding et validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le framework spring aide à la gestion des formulaires sur 2 points essentiels</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le binding : prendre les chaînes de caractères dans la requête et remplir l&#8217;objet</p>
</li>
<li>
<p>La validation : noter toutes les erreurs de conversion lors du binding et être capable d&#8217;afficher des messages d&#8217;erreur</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La JSR 303 (bean validation) simplifie la configuration de la validation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NotEmpty</span>
<span class="directive">private</span> <span class="predefined-type">String</span> name;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RequestMapping</span>(method = RequestMethod.POST)
<span class="directive">public</span> <span class="predefined-type">String</span> post(<span class="annotation">@ModelAttribute</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">person</span><span class="delimiter">&quot;</span></span>) <span class="annotation">@Valid</span> PersonForm form, BindingResult result) {
    <span class="keyword">if</span> (result.hasError()) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">form</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="comment">// suite</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_redirect_after_post">Redirect after POST</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lors du POST du formulaire, des données sont envoyées au serveur.</p>
</div>
<div class="paragraph">
<p>L&#8217;état de la base de données change.</p>
</div>
<div class="paragraph">
<p>Faire un refresh sur un navigateur consiste a refaire la même requête.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, un refresh ferait une deuxième écriture en base.</p>
</div>
<div class="paragraph">
<p>Il est donc impératif que le contrôleur fasse un redirect après une modification en base.</p>
</div>
<div class="paragraph">
<p>Ce pattern est appelé redirect after POST</p>
</div>
<div class="paragraph">
<p>Cela permet d&#8217;éviter l&#8217;insert de doublons en base et d&#8217;assurer le fonctionnement normal du bouton back du navigateur.</p>
</div>
</div>
</div>
</div>
</body>
</html>