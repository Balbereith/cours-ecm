<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Annexe C : L&#8217;injection de dépendances</title>
<link rel="stylesheet" href="./../../style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article">
<div id="header">
<h1>Annexe C : L&#8217;injection de dépendances</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Une application est un réseau riche de composants qui dépendent les uns des autres.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="class-diagram.png" alt="class diagram">
</div>
</div>
<div class="paragraph">
<p>L&#8217;injection de dépendances (DI) permet de mettre ces composants en relation.</p>
</div>
<div class="paragraph">
<p>Chaque composant devient plus autonome et il est plus simple de le tester.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_framework">Spring framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://spring.io/">Spring</a> est un conteneur léger par injection de dépendances.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>il existe d&#8217;autres framework d&#8217;injection de dépendances comme par exemple celui de google <a href="https://github.com/google/guice">Guice</a>.</p>
</div>
<div class="paragraph">
<p>Le guide de Guice explique clairement la motivation derrière l&#8217;injection de dépendance : <a href="https://github.com/google/guice/wiki/Motivation" class="bare">https://github.com/google/guice/wiki/Motivation</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En plus de faire de l&#8217;injection, Spring est une boite à outils riche pour les applications jee.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="spring-overview.png" alt="spring overview">
</div>
</div>
<div class="paragraph">
<p>Nous avons déjà vu sa partie MVC mais il y a bien plus que cela.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exemple">Exemple</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imaginons deux services qui collaborent.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="spring-beans.png" alt="spring beans">
</div>
</div>
<div class="paragraph">
<p>L&#8217;annotation <code>@Inject</code> permet</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleService</span> {
    <span class="annotation">@Inject</span>
    <span class="directive">private</span> OtherService otherService;

    <span class="directive">public</span> <span class="type">void</span> call() { otherService.doSomethingUseful(); }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">OtherService</span> {
    <span class="directive">public</span> <span class="type">void</span> doSomethingUseful() { ... }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
@Inject est le standard jee, spring supporte aussi sa propre annotation @Autowired et une autre annotation standard @Resource.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
il est aussi possible de définir les beans et les injections en xml
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__component">@Component</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En plus de faire de l&#8217;injection, spring peut aussi découvrir les composants par scan</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!--scan le package x.y.z--&gt;</span>
<span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.z</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tous les composants annotés dans les packages sous x.y.z seront chargés.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OtherService</span> {
   <span class="directive">public</span> <span class="type">void</span> doSomethingUseful() { ... }
}

<span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleService</span> {
   <span class="annotation">@Inject</span>
   <span class="directive">private</span> OtherService otherService;

   <span class="directive">public</span> <span class="type">void</span> call() { otherService.doSomethingUseful(); }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@Component</code> est l&#8217;annotation générique.</p>
</div>
<div class="paragraph">
<p><code>@Service</code>, <code>@Repository</code> ou bien <code>@Controller</code> sont plus précis sémantiquement.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aspect_oriented_programming">Aspect Oriented Programming</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La délégation de l&#8217;injection à spring offre la possibilté d&#8217;intercaler du code entre les appels.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="aop-proxy.png" alt="aop proxy" width="600px">
</div>
</div>
<div class="paragraph">
<p>Cette approche est appelée <strong>Aspect Oriented Programming</strong> et peut être mis en place de plusieurs façons :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Création d&#8217;un <strong>proxy dynamique</strong> : création d&#8217;une classe à partir d&#8217;une interface (jdk)</p>
</li>
<li>
<p>à la <strong>compilation</strong> : les aspects sont ajoutés au moment de la compilation</p>
</li>
<li>
<p>au <strong>chargement</strong> : les aspects sont ajoutés au moment du démarrage de l&#8217;application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est particulièrement utile afin de factoriser des traitements <strong>orthogonaux</strong> au code métier.</p>
</div>
<div class="paragraph">
<p>La nomenclature de l&#8217;AOP est complexe : advice, crosscuting, join point, point cut&#8230;&#8203;, mais le principe reste simple : exécuter du code entre l&#8217;appelant et l&#8217;objet cible.</p>
</div>
<div class="sect2">
<h3 id="_exemple_les_transactions">Exemple : les transactions</h3>
<div class="paragraph">
<p>La gestion d&#8217;une transaction sql est tâche répétitive et lourde à écrire</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> doSomethingUseful() {
    <span class="predefined-type">Connection</span> con = <span class="predefined-constant">null</span>;

    <span class="keyword">try</span> {
        con = dataSource.getConnection();
        con.setAutoCommit(<span class="predefined-constant">false</span>); <span class="comment">// Activer les transactions</span>

        <span class="comment">// partie utile</span>
        stmt = con.createStatement();
        stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">update my_table set stock = 3 where id = 15</span><span class="delimiter">&quot;</span></span>);

        con.commit(); <span class="comment">// Commit de la transaction</span>
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        <span class="comment">// Rollback de la transaction en cas d'erreur</span>
        <span class="keyword">if</span> (con != <span class="predefined-constant">null</span>) { con.rollback(); }
    } <span class="keyword">finally</span> {
        <span class="comment">// Libération des ressources</span>
        <span class="keyword">if</span> (con != <span class="predefined-constant">null</span>) { con.close(); }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Grâce à l&#8217;AOP et un gestionnaire de transaction, on peut simplifier le code précédent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="type">void</span> doSomethingUseful() {
    <span class="predefined-type">Connection</span> conn = DataSourceUtils.getConnection(dataSource);

    stmt = con.createStatement();
    stmt.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">update my_table set stock = 3 where id = 15</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est maintenant le framework qui s&#8217;occupe de gérer la transaction et de libérer les ressources.</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>